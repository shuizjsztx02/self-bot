# Self-Bot 项目完整架构

---

## 一、系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Self-Bot 系统架构                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                                 前端层 (Frontend)                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│  │  ChatPage   │  │ SettingsPage│  │ KnowledgePage│  │ SearchPage  │           │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘           │
│         │                │                │                │                   │
│         └────────────────┴────────────────┴────────────────┘                   │
│                                   │                                             │
│         ┌─────────────────────────┴─────────────────────────┐                  │
│         │              Zustand 状态管理                      │                  │
│         │   chatStore.ts  │  knowledgeStore.ts              │                  │
│         └─────────────────────────┬─────────────────────────┘                  │
│                                   │                                             │
│         ┌─────────────────────────┴─────────────────────────┐                  │
│         │               API 服务层                          │                  │
│         │   api.ts  │  knowledgeApi.ts  │  SSE Stream       │                  │
│         └─────────────────────────┬─────────────────────────┘                  │
└───────────────────────────────────┼─────────────────────────────────────────────┘
                                    │ HTTP/SSE
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                 后端层 (Backend)                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                          API 路由层                                      │   │
│  │  /api/chat/stream  │  /api/conversations  │  /api/knowledge-base        │   │
│  └─────────────────────────────────┬───────────────────────────────────────┘   │
│                                    │                                            │
│  ┌─────────────────────────────────┴───────────────────────────────────────┐   │
│  │                        SupervisorAgent (监督者)                          │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                   │   │
│  │  │ IntentClassifier │  │ RouteDecider │  │ ResultSelector │                   │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘                   │   │
│  └─────────────────────────────────┬───────────────────────────────────────┘   │
│                                    │                                            │
│         ┌──────────────────────────┼──────────────────────────┐               │
│         │                          │                          │               │
│         ▼                          ▼                          ▼               │
│  ┌─────────────┐           ┌─────────────┐           ┌─────────────┐         │
│  │  MainAgent  │           │RagAgent     │           │ResearcherAgent│        │
│  │  (主代理)   │           │(RAG代理)    │           │(搜索代理)     │        │
│  └──────┬──────┘           └──────┬──────┘           └──────┬──────┘         │
│         │                         │                         │                │
│         └─────────────────────────┴─────────────────────────┘                │
│                                    │                                            │
│  ┌─────────────────────────────────┴───────────────────────────────────────┐   │
│  │                            LLM 提供者层                                  │   │
│  │  ┌───────┐ ┌─────────┐ ┌──────┐ ┌─────┐ ┌────────┐ ┌────────┐ ┌──────┐ │   │
│  │  │OpenAI │ │DeepSeek │ │ Qwen │ │ GLM │ │Minimax │ │Moonshot│ │Ollama│ │   │
│  │  └───────┘ └─────────┘ └──────┘ └─────┘ └────────┘ └────────┘ └──────┘ │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                    │                                            │
│  ┌─────────────────────────────────┴───────────────────────────────────────┐   │
│  │                            工具执行层                                    │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │   │
│  │  │    内置工具      │  │    MCP 工具      │  │    技能系统     │         │   │
│  │  │ • read_file     │  │ • Word          │  │ • docx         │         │   │
│  │  │ • write_file    │  │ • Excel         │  │ • pdf          │         │   │
│  │  │ • execute_code  │  │ • PPTX          │  │ • pptx         │         │   │
│  │  │ • tavily_search │  │ • Notion        │  │ • mcp-builder  │         │   │
│  │  │ • calculator    │  │ • Feishu        │  │                │         │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                    │                                            │
│  ┌─────────────────────────────────┴───────────────────────────────────────┐   │
│  │                            记忆系统层                                    │   │
│  │  ┌─────────────────────┐          ┌─────────────────────┐              │   │
│  │  │   ShortTermMemory   │          │   LongTermMemory    │              │   │
│  │  │   (短期记忆)         │          │   (长期记忆)         │              │   │
│  │  │ • Token 计数        │          │ • MD 存储           │              │   │
│  │  │ • 滑动窗口          │          │ • Chroma 向量库     │              │   │
│  │  │ • 自动摘要          │          │ • RAG 检索          │              │   │
│  │  └─────────────────────┘          └─────────────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                    │                                            │
│  ┌─────────────────────────────────┴───────────────────────────────────────┐   │
│  │                          知识库模块                                      │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │   │
│  │  │ 文档解析器   │  │ 向量嵌入    │  │ 混合检索    │  │ 来源归因    │   │   │
│  │  │ PDF/DOCX/...│  │ Embedding   │  │ BM25+向量   │  │ Attribution │   │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              数据存储层                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│  │   SQLite    │  │   Chroma    │  │  文件系统    │  │   MCP缓存   │           │
│  │  selfbot.db │  │  向量数据库  │  │  data/      │  │  .mcp_cache │           │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘           │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、技术栈统计

### 前端技术栈

| 类别 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **框架** | React | 18 | UI 框架 |
| **语言** | TypeScript | 5.x | 类型安全 |
| **构建工具** | Vite | 5.x | 开发构建 |
| **路由** | React Router | v6 | 页面导航 |
| **状态管理** | Zustand | 4.x | 全局状态 |
| **HTTP 客户端** | Axios | 1.x | API 请求 |
| **样式** | Tailwind CSS | 3.x | UI 样式 |
| **图标** | Lucide React | - | 图标库 |

### 后端技术栈

| 类别 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **框架** | FastAPI | 0.100+ | Web 框架 |
| **语言** | Python | 3.11+ | 后端语言 |
| **AI 框架** | LangChain | 0.3+ | Agent 框架 |
| **MCP SDK** | mcp | 1.8+ | MCP 协议 |
| **MCP 框架** | fastmcp | 2.0+ | MCP 开发 |
| **数据库** | SQLite | 3 | 关系数据库 |
| **向量数据库** | ChromaDB | 0.4+ | 向量存储 |
| **异步 HTTP** | httpx | 0.25+ | 异步请求 |
| **验证** | Pydantic | 2.x | 数据验证 |
| **环境变量** | python-dotenv | 1.x | 配置管理 |

### 支持的 LLM 提供者

| 提供者 | 模型 | 特点 |
|--------|------|------|
| **OpenAI** | GPT-4o | 默认推荐 |
| **DeepSeek** | deepseek-chat | 国产优质 |
| **Qwen** | qwen-plus | 阿里云 |
| **GLM** | glm-4-plus | 智谱 AI |
| **Minimax** | abab6.5s-chat | MiniMax |
| **Moonshot** | moonshot-v1-8k | 月之暗面 |
| **Ollama** | 本地模型 | 本地部署 |

### MCP 服务器

| 服务器 | 语言 | 功能 |
|--------|------|------|
| **Word** | Python | Word 文档操作 |
| **Excel** | Python | Excel 表格操作 |
| **PPTX** | Python | PPT 演示文稿 |
| **Notion** | Python | 待办事项管理 |
| **Feishu** | Node.js | 飞书集成 (19个工具) |

---

## 三、亮点设计

### 1. 多 Agent 协作架构

```
SupervisorAgent (监督者)
    ├── 意图识别 → 路由决策
    ├── 协调多个 Agent 并行/串行执行
    └── 结果整合与最优选择

MainAgent (主代理)
    ├── LLM 调用与工具执行
    └── 记忆管理

RagAgent (RAG 代理)
    └── 知识库检索增强

ResearcherAgent (搜索代理)
    └── 网络搜索增强
```

**优势**: 专业分工，智能路由，并行执行提升效率

---

### 2. MCP 协议集成

```
标准化工具扩展机制
    ├── JSON-RPC 2.0 通信协议
    ├── stdio 传输层
    ├── 自动工具发现
    └── LangChain 工具转换

已集成 5 个 MCP 服务器
    ├── Word/Excel/PPTX (本地)
    ├── Notion (API)
    └── Feishu (19个工具)
```

**优势**: 可扩展性强，支持多语言 MCP 服务器

---

### 3. 双层记忆系统

```
短期记忆 (ShortTermMemory)
    ├── Token 计数与限制
    ├── 滑动窗口管理
    └── 自动摘要触发

长期记忆 (LongTermMemory)
    ├── Markdown 文件存储
    ├── Chroma 向量索引
    └── RAG 语义检索
```

**优势**: 上下文管理 + 持久化记忆，支持长期对话

---

### 4. 智能路由系统

| 意图类型 | 路由策略 | 执行流程 |
|---------|---------|---------|
| KB_QUERY | rag_first | 知识库检索 → LLM |
| SEARCH_TASK | research_first | 网络搜索 → LLM |
| DOCUMENT_TASK | tool_first | 工具执行 → LLM |
| DATA_ANALYSIS | tool_first | 工具执行 → LLM |
| CODE_TASK | direct | 直接 LLM |
| GENERAL_CHAT | direct | 直接 LLM |

**优势**: 基于意图的动态路由，支持并行执行

---

### 5. 知识库 RAG

```
文档处理流程
    ├── 多格式解析 (PDF/DOCX/XLSX/PPTX/MD)
    ├── 向量嵌入 (Embedding)
    ├── 混合检索 (BM25 + 向量)
    ├── 上下文压缩
    └── 来源归因
```

**优势**: 精准检索，可追溯来源

---

### 6. 流式响应

```
后端: SSE (Server-Sent Events)
    ├── 实时输出 LLM 响应
    ├── 工具调用状态推送
    └── 执行进度反馈

前端: ReadableStream
    ├── 实时渲染流式内容
    └── 打字机效果
```

**优势**: 低延迟，良好用户体验

---

### 7. 技能系统

```
技能定义 (SKILL.md)
    ├── 元数据 (name, description, version)
    ├── 指令模板
    └── 工具权限

技能匹配
    ├── 关键词匹配
    ├── 向量相似度
    └── 动态加载
```

**优势**: 可扩展，可定制化

---

## 四、项目统计

| 指标 | 数量 |
|------|------|
| **前端组件** | 15+ |
| **API 路由** | 20+ |
| **Agent 类型** | 4 |
| **内置工具** | 12 |
| **MCP 工具** | 40+ |
| **技能定义** | 6 |
| **LLM 提供者** | 7 |
| **文档解析器** | 5 |

---

## 五、架构优势总结

| 特性 | 说明 |
|------|------|
| **可扩展性** | MCP 协议 + 技能系统，轻松扩展能力 |
| **可维护性** | 分层架构，职责清晰 |
| **高性能** | 异步处理 + 并行路由 + 流式响应 |
| **智能化** | 多 Agent 协作 + 意图识别 + 智能路由 |
| **记忆持久化** | 双层记忆系统，支持长期对话 |
| **多模型支持** | 统一接口，7+ LLM 提供者 |
| **企业级集成** | 飞书/Notion 等 MCP 工具 |

---

## 六、目录结构

### 后端目录

```
backend/
├── app/
│   ├── main.py                 # FastAPI 应用入口
│   ├── config.py               # 配置管理
│   ├── api/                    # API 路由层
│   ├── auth/                   # 认证授权模块
│   ├── callbacks/              # 回调处理
│   ├── core/                   # 核心模块
│   ├── db/                     # 数据库层
│   ├── knowledge_base/         # 知识库模块
│   ├── langchain/              # LangChain 核心
│   │   ├── agents/             # Agent 实现
│   │   ├── llm.py              # LLM 提供者管理
│   │   ├── memory/             # 记忆系统
│   │   ├── tools/              # 内置工具
│   │   └── prompts/            # 提示词管理
│   ├── mcp/                    # MCP 客户端
│   │   ├── client.py           # MCP 客户端实现
│   │   └── feishu_client.py    # 飞书 MCP 客户端
│   └── skills/                 # 技能系统
├── mcp_servers/                # MCP 服务器集合
│   ├── excel/                  # Excel MCP
│   ├── notion/                 # Notion MCP
│   ├── pptx/                   # PPT MCP
│   └── word/                   # Word MCP
├── skills/                     # 技能定义目录
├── prompts/                    # 提示词模板
├── data/                       # 数据存储
│   ├── chroma/                 # Chroma 向量数据库
│   ├── memories/               # 长期记忆存储
│   └── selfbot.db              # SQLite 数据库
└── run.py                      # 启动脚本
```

### 前端目录

```
frontend/src/
├── App.tsx                    # 应用入口
├── main.tsx                   # React 入口
├── components/                # 组件
│   ├── ChatInput.tsx          # 聊天输入框
│   ├── MessageList.tsx        # 消息列表
│   ├── MessageItem.tsx        # 消息项
│   ├── Sidebar.tsx            # 侧边栏
│   └── ...
├── pages/                     # 页面
│   ├── ChatPage.tsx           # 聊天页面
│   ├── SettingsPage.tsx       # 设置页面
│   └── KnowledgeBasePage.tsx  # 知识库页面
├── services/                  # API 服务
│   ├── api.ts                 # 聊天 API
│   └── knowledgeApi.ts        # 知识库 API
├── stores/                    # 状态管理
│   ├── chatStore.ts           # 聊天状态
│   └── knowledgeStore.ts      # 知识库状态
└── types/                     # 类型定义
```

---

## 七、调用链路

### 完整调用流程

```
用户输入 → 前端组件 → API服务 → 后端路由
                                    │
         ┌──────────────────────────┼──────────────────────────┐
         │                          │                          │
         ▼                          ▼                          ▼
   SupervisorAgent           Knowledge Base              MCP Servers
         │                          │                          │
         ▼                          ▼                          ▼
   LLM Provider              Vector DB (Chroma)          External APIs
   (OpenAI/DeepSeek/...)
         │                          │                          │
         └──────────────────────────┼──────────────────────────┘
                                    │
                                    ▼
                              响应输出 → 状态管理 → UI 渲染
```

### Agent 调用链路

```
SupervisorAgent.chat_stream()
       │
       ├──► IntentClassifier.classify() → 意图识别
       │
       ▼
       _decide_routes() → 路由决策
       │
       ├──► rag_first → RagAgent.search() → MainAgent.chat()
       ├──► research_first → ResearcherAgent.research() → MainAgent.chat()
       └──► direct → MainAgent.chat()
              │
              ▼
         MainAgent.chat()
              │
              ├──► _build_system_prompt() → 加载提示词/记忆/技能
              ├──► llm.bind_tools(tools) → 绑定工具
              └──► Agent 循环: LLM调用 → 工具执行 → 返回响应
```

### MCP 工具调用链路

```
MainAgent._execute_tool(tool_name, tool_args)
       │
       ▼
MCPToolWrapper.__call__(**kwargs)
       │
       ▼
MCPClient.call_tool(name, arguments)
       │
       ├──► JSON-RPC 请求构建
       │
       ├──► stdin.write(request)
       │
       ├──► stdout.readline() → 响应
       │
       └──► 解析响应内容
```
