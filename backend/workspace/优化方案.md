# Self-Bot 项目分阶段优化计划

---

## 优化原则

```
优先级判断标准：
┌─────────────────────────────────────────────────────────────────┐
│  威胁度 │ 高 │ 中 │ 低 │
│─────────────┼────────┼────────┼────────┤
│ 高 │ P0-紧急 │ P1-重要 │ P2-一般 │
│ 中 │ P1-重要 │ P2-一般 │ P3-可选 │
│ 低 │ P2-一般 │ P3-可选 │ P4-延后 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 阶段一：安全加固 (P0 - 紧急)

**目标**：消除严重安全漏洞，确保系统安全可控

**预计工期**：3-5 天

### 1.1 代码执行沙箱化

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **1.1.1 Docker 沙箱设计** | 设计隔离执行环境架构 | 沙箱架构文档 |
| **1.1.2 沙箱镜像构建** | 创建 Python 执行环境 Docker 镜像 | `Dockerfile.sandbox` |
| **1.1.3 执行器重构** | 将 `exec()` 替换为容器化执行 | `code_tools.py` 重构 |
| **1.1.4 资源限制** | 添加 CPU/内存/执行时间限制 | 资源限制配置 |
| **1.1.5 安全审计** | 添加执行日志和审计追踪 | 审计日志模块 |

```python
# 重构方向示例
# 当前 (危险):
def execute_code(code: str) -> str:
    exec(code, {"__builtins__": {}})  # 不安全

# 优化后 (安全):
async def execute_code_sandbox(code: str) -> str:
    container = docker_client.containers.run(
        "python-sandbox:latest",
        command=f"python -c '{code}'",
        mem_limit="128m",
        cpu_period=100000,
        cpu_quota=50000,
        timeout=10,
        network_disabled=True,
    )
    return container.output
```

### 1.2 异步模型统一

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **1.2.1 移除同步包装** | 删除 `get_*_sync()` 函数 | `client.py` 清理 |
| **1.2.2 统一异步接口** | 所有 MCP 调用改为纯异步 | 异步接口规范 |
| **1.2.3 事件循环管理** | 使用 `asyncio.run()` 统一入口 | 事件循环处理器 |

### 1.3 输入验证加固

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **1.3.1 参数校验** | 添加工具输入参数严格校验 | 参数校验装饰器 |
| **1.3.2 敏感数据脱敏** | 日志中自动脱敏敏感信息 | 脱敏工具类 |
| **1.3.3 路径遍历防护** | 文件操作路径安全检查 | 路径安全验证器 |

---

## 阶段二：稳定性提升 (P1 - 重要)

**目标**：提升系统稳定性，防止级联故障

**预计工期**：5-7 天

### 2.1 熔断降级机制

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **2.1.1 熔断器实现** | 实现 Circuit Breaker 模式 | `circuit_breaker.py` |
| **2.1.2 LLM 调用熔断** | LLM Provider 级别熔断 | LLM 熔断装饰器 |
| **2.1.3 MCP 服务熔断** | MCP 服务器级别熔断 | MCP 熔断配置 |
| **2.1.4 降级策略** | 定义服务降级逻辑 | 降级策略配置 |

```python
# 熔断器设计
class CircuitBreaker:
    STATES = ["closed", "open", "half_open"]
    
    def __init__(self, failure_threshold=5, recovery_timeout=60):
        self.failure_threshold = failure_threshold
        self.recovery_timeout = recovery_timeout
        self.state = "closed"
        self.failure_count = 0
    
    async def call(self, func, *args, **kwargs):
        if self.state == "open":
            if self._should_try_recovery():
                self.state = "half_open"
            else:
                raise CircuitBreakerOpen(f"Circuit breaker is open")
        
        try:
            result = await func(*args, **kwargs)
            self._on_success()
            return result
        except Exception as e:
            self._on_failure()
            raise
```

### 2.2 重试策略优化

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **2.2.1 指数退避** | 实现指数退避重试 | 重试策略模块 |
| **2.2.2 抖动算法** | 添加随机抖动避免惊群 | 抖动算法实现 |
| **2.2.3 可重试错误分类** | 区分可重试/不可重试错误 | 错误分类器 |

### 2.3 超时处理完善

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **2.3.1 MCP 超时优化** | 完善错误信息捕获 | `client.py` 优化 |
| **2.3.2 LLM 超时配置** | 分 Provider 配置超时 | 超时配置文件 |
| **2.3.3 全局超时控制** | 请求级别总超时限制 | 超时中间件 |

### 2.4 错误处理统一

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **2.4.1 自定义异常** | 定义业务异常类型体系 | `exceptions.py` |
| **2.4.2 全局异常处理器** | FastAPI 全局异常处理 | 异常处理器 |
| **2.4.3 错误响应标准化** | 统一错误响应格式 | 错误响应模型 |

---

## 阶段三：性能优化 (P2 - 一般)

**目标**：提升系统响应速度，降低资源消耗

**预计工期**：7-10 天

### 3.1 缓存策略实现

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **3.1.1 意图分类缓存** | 相似查询意图缓存 | 意图缓存模块 |
| **3.1.2 工具结果缓存** | LRU 缓存 + TTL | 工具缓存装饰器 |
| **3.1.3 向量检索缓存** | 向量缓存 + 近似检索 | 向量缓存层 |
| **3.1.4 缓存失效策略** | 定义缓存更新/失效规则 | 缓存策略配置 |

```python
# 缓存架构设计
class CacheLayer:
    def __init__(self):
        self.l1_cache = LRUCache(maxsize=1000)  # 内存缓存
        self.l2_cache = RedisCache()            # Redis 缓存
    
    async def get_or_compute(self, key: str, compute_func, ttl: int = 3600):
        # L1 查找
        if result := self.l1_cache.get(key):
            return result
        
        # L2 查找
        if result := await self.l2_cache.get(key):
            self.l1_cache.set(key, result)
            return result
        
        # 计算
        result = await compute_func()
        self.l1_cache.set(key, result)
        await self.l2_cache.set(key, result, ttl)
        return result
```

### 3.2 Agent 实例池化

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **3.2.1 Agent 池设计** | 会话级别 Agent 缓存池 | Agent 池管理器 |
| **3.2.2 生命周期管理** | Agent 创建/复用/销毁 | 生命周期策略 |
| **3.2.3 记忆持久化** | 会话记忆跨实例共享 | 记忆持久化层 |

### 3.3 并行执行优化

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **3.3.1 工具并行调用** | 独立工具并行执行 | 并行执行器 |
| **3.3.2 并行路由流式** | 并行路由 SSE 流式输出 | 流式合并器 |
| **3.3.3 结果流式合并** | 多路由结果实时合并 | 结果合并策略 |

### 3.4 懒加载优化

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **3.4.1 MCP 工具懒加载** | 按需加载 MCP 服务器 | 懒加载管理器 |
| **3.4.2 技能懒加载** | 首次使用时加载技能 | 技能加载器 |
| **3.4.3 向量存储懒初始化** | 首次检索时初始化 | 向量存储管理 |

---

## 阶段四：可维护性提升 (P2 - 一般)

**目标**：降低维护成本，提升代码质量

**预计工期**：5-7 天

### 4.1 意图分类配置化

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **4.1.1 规则配置文件** | 正则模式迁移到 YAML | `intent_rules.yaml` |
| **4.1.2 关键词配置** | 关键词映射迁移到 YAML | `intent_keywords.yaml` |
| **4.1.3 配置热加载** | 支持配置文件热更新 | 配置热加载器 |
| **4.1.4 规则测试框架** | 规则有效性测试 | 规则测试套件 |

```yaml
# intent_rules.yaml 示例
intent_rules:
  code_task:
    patterns:
      - "写(一个|段|个).*代码"
      - "python|java|javascript|go|rust"
      - "函数|类|方法|接口|模块"
    threshold: 0.95
    
  search_task:
    patterns:
      - "搜索|查一下|找一下|搜一下"
      - "最新|最近|今天.*新闻"
    threshold: 0.90
    
  kb_query:
    patterns:
      - "公司.*制度|流程|规定|政策"
      - "产品.*手册|文档|说明"
    threshold: 0.85
    kb_hints:
      - pattern: "财务|报销|预算"
        kbs: ["财务知识库"]
      - pattern: "制度|流程|规定"
        kbs: ["公司制度库"]
```

### 4.2 日志框架统一

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **4.2.1 日志配置** | 统一 logging 配置 | `logging_config.py` |
| **4.2.2 结构化日志** | JSON 格式日志输出 | 结构化日志格式 |
| **4.2.3 日志级别规范** | 定义各级别使用场景 | 日志规范文档 |
| **4.2.4 print 替换** | 全局替换 print 为 logging | 代码清理 |

### 4.3 依赖注入统一

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **4.3.1 DI 框架引入** | 引入 dependency-injector | DI 容器配置 |
| **4.3.2 组件注册** | 核心组件注册到容器 | 组件注册表 |
| **4.3.3 测试支持** | DI 支持测试 Mock | 测试工具类 |

---

## 阶段五：可观测性增强 (P3 - 可选)

**目标**：提升系统可观测性，便于问题排查

**预计工期**：5-7 天

### 5.1 监控指标收集

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **5.1.1 指标定义** | 定义核心业务指标 | 指标定义文件 |
| **5.1.2 Prometheus 集成** | 集成 Prometheus 客户端 | Prometheus 配置 |
| **5.1.3 指标暴露端点** | `/metrics` 端点暴露 | 指标端点 |
| **5.1.4 自定义指标** | 业务相关自定义指标 | 自定义指标类 |

### 5.2 健康检查完善

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **5.2.1 健康检查端点** | `/health` 详细健康状态 | 健康检查端点 |
| **5.2.2 依赖检查** | 检查数据库/LLM/MCP 状态 | 依赖检查器 |
| **5.2.3 就绪检查** | `/ready` 服务就绪检查 | 就绪检查端点 |

### 5.3 追踪增强

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **5.3.1 追踪数据持久化** | 执行追踪数据存储 | 追踪存储模块 |
| **5.3.2 追踪查询 API** | 追踪数据查询接口 | 追踪查询 API |
| **5.3.3 性能分析** | 基于追踪的性能分析 | 性能分析工具 |

---

## 阶段六：功能扩展 (P4 - 延后)

**目标**：扩展系统能力，提升用户体验

**预计工期**：10-15 天

### 6.1 多模态支持

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **6.1.1 图像理解** | 集成 Vision 模型 | 图像处理模块 |
| **6.1.2 OCR 支持** | 图片文字提取 | OCR 集成 |
| **6.1.3 语音输入** | ASR 语音转文字 | 语音处理模块 |

### 6.2 个性化引擎

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **6.2.1 用户偏好学习** | 从历史交互学习偏好 | 偏好学习模块 |
| **6.2.2 响应风格调整** | 根据偏好调整响应 | 风格调整器 |
| **6.2.3 主动建议** | 基于上下文主动建议 | 建议生成器 |

### 6.3 LangGraph 编排升级

| 任务 | 具体内容 | 产出物 |
|------|----------|--------|
| **6.3.1 状态机设计** | 设计 Agent 状态流转 | 状态机设计文档 |
| **6.3.2 LangGraph 集成** | 迁移到 LangGraph 编排 | LangGraph 配置 |
| **6.3.3 条件边实现** | 实现条件路由边 | 条件边定义 |

---

## 优化计划总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Self-Bot 优化路线图                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  阶段一 (P0)          阶段二 (P1)          阶段三 (P2)                       │
│  安全加固             稳定性提升           性能优化                          │
│  ┌─────────┐         ┌─────────┐         ┌─────────┐                        │
│  │代码沙箱 │         │熔断降级 │         │缓存策略 │                        │
│  │异步统一 │   ──►   │重试策略 │   ──►   │Agent池化│                        │
│  │输入验证 │         │超时处理 │         │并行优化 │                        │
│  └─────────┘         └─────────┘         └─────────┘                        │
│  3-5 天               5-7 天               7-10 天                           │
│                                                                              │
│         │                   │                   │                           │
│         ▼                   ▼                   ▼                           │
│                                                                              │
│  阶段四 (P2)          阶段五 (P3)          阶段六 (P4)                       │
│  可维护性提升         可观测性增强         功能扩展                          │
│  ┌─────────┐         ┌─────────┐         ┌─────────┐                        │
│  │配置化   │         │监控指标 │         │多模态   │                        │
│  │日志统一 │   ──►   │健康检查 │   ──►   │个性化   │                        │
│  │依赖注入 │         │追踪增强 │         │LangGraph│                        │
│  └─────────┘         └─────────┘         └─────────┘                        │
│  5-7 天               5-7 天               10-15 天                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

总工期: 35-51 天 (约 5-7 周)
```

---

## 每阶段验收标准

| 阶段 | 验收标准 |
|------|----------|
| **阶段一** | 代码执行无安全漏洞，所有同步包装函数移除，输入验证覆盖率 100% |
| **阶段二** | 熔断器测试通过，重试策略有效，错误处理统一，系统稳定性 > 99% |
| **阶段三** | 缓存命中率 > 30%，Agent 创建开销降低 50%，并行路由流式正常 |
| **阶段四** | 意图规则配置化完成，日志统一为 logging，DI 容器配置完成 |
| **阶段五** | Prometheus 指标正常采集，健康检查端点正常，追踪数据可查询 |
| **阶段六** | 多模态输入正常，个性化推荐有效，LangGraph 编排正常运行 |

---

## 关键风险点汇总

### 高风险

| 风险点 | 位置 | 说明 | 影响 |
|--------|------|------|------|
| **代码执行安全漏洞** | `code_tools.py:execute_code` | 使用 `exec()` 执行用户代码，无沙箱隔离 | 可能执行恶意代码，系统被完全控制 |
| **MCP 进程超时处理** | `client.py:97-113` | 超时后只读取 1KB stderr，丢失错误信息 | 生产环境问题排查困难 |
| **异步事件循环冲突** | `client.py:398-420` | 同步函数中使用 `run_until_complete()` | 在已有事件循环环境中会失败 |

### 中等风险

| 风险点 | 位置 | 说明 | 影响 |
|--------|------|------|------|
| **Agent 实例化开销** | `main_agent.py:18-81` | 每次请求创建新实例，包含多个重量级组件 | 性能损耗，内存压力，上下文丢失 |
| **意图分类硬编码** | `intent_classifier.py:87-152` | 大量硬编码正则模式和关键词 | 维护成本高，扩展性差 |
| **并行路由流式不完整** | `supervisor_agent.py:485-506` | 并行路由流式输出只选第一个路由 | 无法实现真正的并行流式体验 |
| **状态管理内存泄漏** | `state.py:61-159` | 会话存储在类变量，依赖手动清理 | 长时间运行内存积累 |

### 低风险

| 风险点 | 位置 | 说明 | 影响 |
|--------|------|------|------|
| **工具描述截断** | `main_agent.py:172-176` | 工具描述只取前 100 字符 | 可能丢失重要信息 |
| **错误处理不一致** | 多处 | 混用 `print()` 和 `logging` | 日志管理混乱 |
| **MCP 工具加载时机** | `main.py` | 应用启动时同步加载 MCP 工具 | 启动时间延长 |

---

**此计划可按阶段逐步实施，每阶段完成后进行验收测试，确保系统稳定性后再进入下一阶段。**
